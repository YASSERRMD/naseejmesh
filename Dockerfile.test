# Test runner Dockerfile
FROM rust:1.75-bookworm AS builder

# Install build dependencies
RUN apt-get update && apt-get install -y \
    pkg-config \
    libssl-dev \
    clang \
    cmake \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /app

# Copy workspace files
COPY Cargo.toml Cargo.lock ./
COPY crates ./crates

# Build dependencies first (for caching)
RUN cargo build --all --release 2>/dev/null || true

# Build tests
RUN cargo test --all --no-run --release

# Runtime stage
FROM debian:bookworm-slim

RUN apt-get update && apt-get install -y \
    ca-certificates \
    libssl3 \
    curl \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /app

# Copy from builder
COPY --from=builder /app/target /app/target
COPY --from=builder /app/Cargo.toml /app/Cargo.lock ./
COPY --from=builder /app/crates ./crates
COPY --from=builder /usr/local/cargo /usr/local/cargo

ENV PATH="/usr/local/cargo/bin:${PATH}"

CMD ["cargo", "test", "--all", "--no-fail-fast"]
